<!DOCTYPE html>
<html lang="en">
<head>
Â  <meta charset="UTF-8" />
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
Â  <title>FPG Pairing Manager - ADMIN</title>

Â  Â  <script src="https://cdn.tailwindcss.com"></script>
Â  <script>
Â  Â  // Brand colors for Tailwind utility classes
Â  Â  tailwind.config = {
Â  Â  Â  theme: {
Â  Â  Â  Â  extend: {
Â  Â  Â  Â  Â  colors: {
Â  Â  Â  Â  Â  Â  'fpg-primary': '#3c763d',
Â  Â  Â  Â  Â  Â  'fpg-accent':Â  '#e6b800',
Â  Â  Â  Â  Â  Â  'fpg-success': '#d4edda'
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  }
Â  </script>

Â  <style>
Â  Â  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
Â  Â  :root{
Â  Â  Â  --fpg-primary:#3c763d;
Â  Â  Â  --fpg-accent:#e6b800;
Â  Â  Â  --fpg-success:#d4edda;
Â  Â  Â  --gray-100:#f3f4f6;
Â  Â  Â  --gray-600:#4b5563;
Â  Â  Â  --drop-hover:#e9f7ec; /* light green for drop hover */
Â  Â  }
Â  Â  body{ font-family: 'Inter', sans-serif; }
Â  Â  .player-card{ cursor: grab; touch-action: none; }
Â  Â  .modal{ transition: opacity .2s ease-in-out; }
Â  Â  .player-drop-zone.over{ background-color: var(--drop-hover); }
Â  Â  .calculated-time{
Â  Â  Â  background-color: var(--gray-100);
Â  Â  Â  color: var(--gray-600);
Â  Â  Â  cursor: not-allowed;
Â  Â  Â  font-weight: 500;
Â  Â  }
Â  </style>

Â  Â  <script src="https://unpkg.com/@dnd-kit/core@6.0.0/dist/dnd-kit-core.js"></script>
</head>

<body class="bg-gray-100 min-h-screen p-4 sm:p-8">
Â  <div class="max-w-6xl mx-auto space-y-8">
Â  Â  <header class="text-center">
Â  Â  Â  Â  Â  Â  <img
Â  Â  Â  Â  src="https://raw.githubusercontent.com/tkdbrad03/fpg-scorekeeper/main/fpg-logo.png"
Â  Â  Â  Â  alt="FPG League Logo"
Â  Â  Â  Â  class="mx-auto h-16 w-auto mb-4"
Â  Â  Â  Â  onerror="this.onerror=null;this.src='https://raw.githubusercontent.com/tkdbrad03/fpg-scorekeeper/main/fpg-logo.png';"
Â  Â  Â  />
Â  Â  Â  <h1 class="text-4xl font-extrabold text-fpg-primary mb-2">FPG Pairing Manager</h1>
Â  Â  Â  <p class="text-gray-600">Drag and drop players to create foursomes, then publish to the public viewer.</p>
Â  Â  </header>

Â  Â  Â  Â  <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-fpg-primary">
Â  Â  Â  <h2 class="text-xl font-semibold text-gray-800 mb-4">Configuration & Status</h2>
Â  Â  Â  <div class="flex flex-col sm:flex-row justify-between items-center space-y-2 sm:space-y-0">
Â  Â  Â  Â  <p class="text-sm font-medium text-gray-700">
Â  Â  Â  Â  Â  BIN ID: <span id="binIdDisplay" class="font-mono text-fpg-primary">68f6557dae596e708f1f69d1</span>
Â  Â  Â  Â  </p>
Â  Â  Â  Â  <button onclick="clearMasterKey()" id="clearKeyButton" class="px-3 py-1 text-xs font-semibold text-red-600 bg-red-100 rounded-full hover:bg-red-200 transition">
Â  Â  Â  Â  Â  Clear Admin Key
Â  Â  Â  Â  </button>
Â  Â  Â  Â  
Â  Â  Â  </div>
Â  Â  Â  <p id="statusMessage" class="text-sm text-gray-700 mt-2">Loading check-in data...</p>
Â  Â  </div>

Â  Â  Â  Â  <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-fpg-accent">
Â  Â  Â  <h2 class="text-xl font-semibold text-gray-800 mb-4">Weekly Tee Time Configuration</h2>
Â  Â  Â  <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
Â  Â  Â  Â  <input type="text" id="time-0" placeholder="Start Time (e.g., 9:00 AM)" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-fpg-accent focus:border-fpg-accent" onchange="calculateTeeTimes()" />
Â  Â  Â  Â  <input type="text" id="time-1" placeholder="Time 2 (+8 min)" readonly class="w-full p-2 border border-gray-300 rounded-lg calculated-time" />
Â  Â  Â  Â  <input type="text" id="time-2" placeholder="Time 3 (+16 min)" readonly class="w-full p-2 border border-gray-300 rounded-lg calculated-time" />
Â  Â  Â  Â  <input type="text" id="time-3" placeholder="Time 4 (+24 min)" readonly class="w-full p-2 border border-gray-300 rounded-lg calculated-time" />
Â  Â  Â  </div>
Â  Â  Â  <p id="timeStatus" class="text-sm text-gray-500 mt-3">Times loaded from your previous session.</p>
Â  Â  </div>

Â  Â  Â  Â  <div class="grid grid-cols-1 md:col-span-5 gap-6">
Â  Â  Â  <div class="grid grid-cols-1 md:grid-cols-5 gap-6">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="col-span-1 bg-white p-4 rounded-xl shadow-lg h-full max-h-[80vh] overflow-y-auto">
Â  Â  Â  Â  Â  <h3 class="text-lg font-bold text-gray-800 mb-3 border-b pb-2">Unpaired Players (<span id="unpairedCount">0</span>)Â  Â  Â  Â  </h3>
Â  Â  Â  Â  Â  <div id="unpairedContainer" class="space-y-2 player-drop-zone" data-group="unpaired" data-time="N/A"></div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="teeTimeContainer" class="col-span-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4"></div>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  Â  Â  <div class="text-center pt-4">
Â  Â  Â  <button onclick="checkAndPublish()" id="publishButton"
Â  Â  Â  Â  class="px-10 py-4 bg-fpg-accent text-white font-semibold text-lg rounded-xl shadow-xl hover:bg-green-700 transition duration-150 ease-in-out disabled:opacity-50">
Â  Â  Â  Â  Publish Pairings to Public Viewer
Â  Â  Â  </button>
Â  Â  </div>
Â  </div>

Â  Â  <div id="keyModal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center opacity-0 pointer-events-none z-50">
Â  Â  <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm transform transition-all scale-95">
Â  Â  Â  <h3 class="text-xl font-bold mb-4 text-red-600">Admin Authentication Required</h3>
Â  Â  Â  <p class="text-sm text-gray-700 mb-4">
Â  Â  Â  Â  To securely update the pairings, please enter the <strong>jsonbin.io Master Key</strong>. This key is saved in your browserâ€™s local storage for future use.
Â  Â  Â  </p>
Â  Â  Â  <input type="password" id="masterKeyInput" placeholder="Master Key (e.g., $2a$10$QW...)"
Â  Â  Â  Â  class="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:ring-fpg-primary focus:border-fpg-primary" />
Â  Â  Â  <div class="flex justify-end space-x-3">
Â  Â  Â  Â  <button onclick="closeModal()" class="px-4 py-2 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300 transition">Cancel</button>
Â  Â  Â  Â  <button onclick="authenticateAndPublish()" id="authButton" class="px-4 py-2 bg-fpg-primary text-white font-medium rounded-lg hover:bg-fpg-accent transition">Authenticate & Publish</button>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

Â  <script type="module">
Â  Â  // ================= CONFIG =================
Â  Â  const FINAL_PAIRINGS_BIN_ID = '68f6557dae596e708f1f69d1';
Â  Â Â 
Â  Â  // âŒ THIS IS THE LIKELY SOURCE OF YOUR 404 ERROR.Â 
Â  Â  // The published link for this Google Sheet has probably expired, been deleted, or the sheetÂ 
Â  Â  // was unpublished. You must generate a new published CSV link for your sheet.
Â  Â  const CHECK_IN_API_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS6XoBTQryAiLHQzKVboT3zij3gekRO0ywjtEg6DGhgjkFzlkEdBe22RZ-f_1TZrs-qewzAWBipaG_B/pub?gid=907219414&single=true&output=csv";


Â  Â  // ================ CONSTANTS ================
Â  Â  const DEFAULT_TEE_TIMES = ['9:00 AM', '9:08 AM', '9:16 AM', '9:24 AM'];
Â  Â  const MAX_PLAYERS_PER_GROUP = 4;
Â  Â  const TEE_TIME_INTERVAL = 8; // minutes
Â  Â  const LOCAL_STORAGE_KEY = 'fpg_master_key';
Â  Â  const LOCAL_STORAGE_TIMES_KEY = 'fpg_tee_times';

Â  Â  let currentTeeTimes = [...DEFAULT_TEE_TIMES];
Â  Â  let allPlayers = [];

Â  Â  const statusElement = document.getElementById('statusMessage');
Â  Â  const unpairedContainer = document.getElementById('unpairedContainer');
Â  Â  const teeTimeWrapper = document.getElementById('teeTimeContainer');
Â  Â  const publishButton = document.getElementById('publishButton');
Â  Â  const keyModal = document.getElementById('keyModal');
Â  Â  const timeStatusElement = document.getElementById('timeStatus');

Â  Â  // ============== TIME HELPERS ==============
Â  Â  function parseTime(timeStr){
Â  Â  Â  const today = new Date();
Â  Â  Â  const match = timeStr.match(/(\d{1,2}):(\d{2})\s*(am|pm)?/i);
Â  Â  Â  if(!match) return null;
Â  Â  Â  let [_, h, m, ap] = match;
Â  Â  Â  h = parseInt(h,10); m = parseInt(m,10);
Â  Â  Â  if(ap){
Â  Â  Â  Â  if(ap.toLowerCase()==='pm' && h<12) h+=12;
Â  Â  Â  Â  else if(ap.toLowerCase()==='am' && h===12) h=0;
Â  Â  Â  }else if(h<7){ h+=12; }
Â  Â  Â  today.setHours(h,m,0,0);
Â  Â  Â  return today;
Â  Â  }
Â  Â  function formatTime(date){
Â  Â  Â  if(!date) return '';
Â  Â  Â  let h = date.getHours();
Â  Â  Â  const m = date.getMinutes();
Â  Â  Â  const ap = h>=12?'PM':'AM';
Â  Â  Â  h = h%12; h = h? h:12;
Â  Â  Â  const mm = m<10? '0'+m : m;
Â  Â  Â  return `${h}:${mm} ${ap}`;
Â  Â  }

Â  Â  // ============ TEE TIME MANAGEMENT ============
Â  Â  function calculateTeeTimes(){
Â  Â  Â  const startTimeInput = document.getElementById('time-0');
Â  Â  Â  const startTimeStr = startTimeInput.value.trim();
Â  Â  Â  const startDate = parseTime(startTimeStr);
Â  Â  Â  const newTimes = [];

Â  Â  Â  if(!startDate || startTimeStr===''){
Â  Â  Â  Â  newTimes.push(startTimeStr || '');
Â  Â  Â  Â  for(let i=1;i<4;i++) newTimes.push('');
Â  Â  Â  Â  timeStatusElement.textContent = 'Please enter a valid start time (e.g., 9:00 AM).';
Â  Â  Â  Â  timeStatusElement.className = 'text-sm mt-3 font-medium text-red-500';
Â  Â  Â  } else {
Â  Â  Â  Â  let t = new Date(startDate.getTime() - TEE_TIME_INTERVAL*60*1000);
Â  Â  Â  Â  for(let i=0;i<4;i++){
Â  Â  Â  Â  Â  t.setMinutes(t.getMinutes()+TEE_TIME_INTERVAL);
Â  Â  Â  Â  Â  newTimes.push(formatTime(t));
Â  Â  Â  Â  }
Â  Â  Â  Â  timeStatusElement.textContent = 'Tee times calculated and saved successfully to this browser!';
Â  Â  Â  Â  timeStatusElement.className = 'text-sm mt-3 font-medium text-green-700';
Â  Â  Â  }

Â  Â  Â  newTimes.forEach((time, i)=>{
Â  Â  Â  Â  const el = document.getElementById(`time-${i}`);
Â  Â  Â  Â  if(el) el.value = time;
Â  Â  Â  });

Â  Â  Â  localStorage.setItem(LOCAL_STORAGE_TIMES_KEY, JSON.stringify(newTimes));
Â  Â  Â  currentTeeTimes = newTimes;

Â  Â  Â  setupContainers();
Â  Â  Â  if(allPlayers.length>0) renderPlayers();
Â  Â  }
Â  Â  function loadTeeTimes(){
Â  Â  Â  const saved = localStorage.getItem(LOCAL_STORAGE_TIMES_KEY);
Â  Â  Â  let times = DEFAULT_TEE_TIMES;
Â  Â  Â  if(saved){
Â  Â  Â  Â  try{ times = JSON.parse(saved); }catch{ localStorage.removeItem(LOCAL_STORAGE_TIMES_KEY); }
Â  Â  Â  }
Â  Â  Â  const startInput = document.getElementById('time-0');
Â  Â  Â  if(startInput) startInput.value = times[0] || '';
Â  Â  Â  calculateTeeTimes();
Â  Â  Â  timeStatusElement.textContent = saved ? 'Times loaded from your previous session.' : 'Using default times. Edit the Start Time above to calculate others.';
Â  Â  }

Â  Â  // ============== KEY & MODAL ==============
Â  Â  function getMasterKey(){ return localStorage.getItem(LOCAL_STORAGE_KEY); }
Â  Â  function setMasterKey(k){ localStorage.setItem(LOCAL_STORAGE_KEY, k); }
Â  Â  function clearMasterKey(){
Â  Â  Â  localStorage.removeItem(LOCAL_STORAGE_KEY);
Â  Â  Â  statusElement.textContent = 'Admin Key successfully cleared from this browser.';
Â  Â  Â  statusElement.className = 'text-center font-medium text-green-700';
Â  Â  }
Â  Â  function openModal(){
Â  Â  Â  keyModal.classList.remove('opacity-0','pointer-events-none');
Â  Â  Â  keyModal.querySelector('div').classList.remove('scale-95');
Â  Â  Â  document.getElementById('masterKeyInput').value = getMasterKey() || '';
Â  Â  }
Â  Â  function closeModal(){
Â  Â  Â  keyModal.classList.add('opacity-0','pointer-events-none');
Â  Â  Â  keyModal.querySelector('div').classList.add('scale-95');
Â  Â  }
Â  Â  async function authenticateAndPublish(){
Â  Â  Â  const input = document.getElementById('masterKeyInput');
Â  Â  Â  const key = input.value.trim();
Â  Â  Â  if(!key || key.length<10){
Â  Â  Â  Â  input.classList.add('border-red-500');
Â  Â  Â  Â  statusElement.textContent = 'Error: Please enter a valid key.';
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  input.classList.remove('border-red-500');
Â  Â  Â  setMasterKey(key);
Â  Â  Â  closeModal();
Â  Â  Â  await publishPairings(key);
Â  Â  }
Â  Â  function checkAndPublish(){
Â  Â  Â  const key = getMasterKey();
Â  Â  Â  if(key){ publishPairings(key); } else { openModal(); }
Â  Â  }
Â  Â  
Â  Â  // ğŸ›‘ FUNCTION MOVED HERE FOR GLOBAL ACCESS AND CONSISTENCY
Â  Â  function updateScorekeeperDropdowns() {
Â  Â  Â  currentTeeTimes.forEach((time, idx) => {
Â  Â  Â  Â  const groupZone = document.querySelector(`.player-drop-zone[data-group="${idx}"]`);
Â  Â  Â  Â  if (!groupZone) return;

Â  Â  Â  Â  // Collect player names currently in this group
Â  Â  Â  Â  const playerCards = Array.from(groupZone.querySelectorAll('.player-card'));
Â  Â  Â  Â  const players = playerCards.map(card => card.textContent.trim());

Â  Â  Â  Â  // Get the dropdowns for this group
Â  Â  Â  Â  const scorekeeper1 = document.getElementById(`scorekeeper1-${idx}`);
Â  Â  Â  Â  const scorekeeper2 = document.getElementById(`scorekeeper2-${idx}`);

Â  Â  Â  Â  // Reset and populate each dropdown
Â  Â  Â  Â  [scorekeeper1, scorekeeper2].forEach(select => {
Â  Â  Â  Â  Â  if (!select) return;
Â  Â  Â  Â  Â  Â // Preserve selected value if it's still a valid option
Â  Â  Â  Â  Â  const selectedValue = select.value;

Â  Â  Â  Â  Â  select.innerHTML = '<option value="">Select Player</option>';
Â  Â  Â  Â  Â  players.forEach(name => {
Â  Â  Â  Â  Â  Â  const opt = document.createElement('option');
Â  Â  Â  Â  Â  Â  opt.value = name;
Â  Â  Â  Â  Â  Â  opt.textContent = name;
Â  Â  Â  Â  Â  Â  select.appendChild(opt);
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  // Re-select the value if it still exists
Â  Â  Â  Â  Â  if (players.includes(selectedValue)) {
Â  Â  Â  Â  Â  Â  select.value = selectedValue;
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  select.value = ""; // Default to "Select Player" if the keeper was dragged out
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  });
Â  Â  }


Â  Â  // ============== UI BUILDERS ==============
function setupContainers() {
Â  teeTimeWrapper.innerHTML = '';
Â  currentTeeTimes.forEach((time, idx) => {
Â  Â  const el = document.createElement('div');
Â  Â  el.id = `group-container-${idx}`;
Â  Â  // ğŸ› ï¸ Adjusted h-full to flex-col and overflow-hidden to accommodate fixed-height footer
Â  Â  el.className = 'bg-white p-4 rounded-xl shadow-lg border border-gray-200 flex flex-col';
Â  Â  
Â  Â  // 1. Header
Â  Â  el.innerHTML = `
Â  Â  Â  <h4 class="text-md font-extrabold text-fpg-primary mb-3 border-b pb-2 flex-shrink-0">
Â  Â  Â  Â  Tee Time ${time} <span class="text-sm font-normal text-gray-500">(Group ${idx + 1})</span>
Â  Â  Â  </h4>
Â  Â  `;

Â  Â  // 2. Player Drop Zone (takes remaining vertical space)
Â  Â  const dropZone = document.createElement('div');
Â  Â  dropZone.className = 'player-drop-zone flex-grow space-y-2 mb-3 min-h-[100px] overflow-y-auto'; // Add overflow-y-auto to drop zone
Â  Â  dropZone.setAttribute('data-time', time);
Â  Â  dropZone.setAttribute('data-group', idx);
Â  Â  el.appendChild(dropZone);


Â  Â  // 3. Scorekeeper Dropdowns (fixed at the bottom)
Â  Â  const dropdowns = document.createElement('div');
Â  Â  dropdowns.className = 'bg-gray-50 p-3 rounded-lg border border-gray-200 space-y-2 flex-shrink-0';
Â  Â  dropdowns.innerHTML = `
Â  Â  Â  <label class="block text-xs font-semibold text-gray-700 uppercase tracking-wider">
Â  Â  Â  Â  Scorekeeper 1
Â  Â  Â  </label>
Â  Â  Â  <select id="scorekeeper1-${idx}"Â 
Â  Â  Â  Â  Â  Â  Â  Â  class="w-full border border-gray-300 rounded-lg p-2 text-sm">
Â  Â  Â  Â  <option value="">Select Player</option>
Â  Â  Â  </select>

Â  Â  Â  <label class="block text-xs font-semibold text-gray-700 uppercase tracking-wider mt-2">
Â  Â  Â  Â  Scorekeeper 2
Â  Â  Â  </label>
Â  Â  Â  <select id="scorekeeper2-${idx}"Â 
Â  Â  Â  Â  Â  Â  Â  Â  class="w-full border border-gray-300 rounded-lg p-2 text-sm">
Â  Â  Â  Â  <option value="">Select Player</option>
Â  Â  Â  </select>
Â  Â  `;
Â  Â  el.appendChild(dropdowns);
Â  Â  
Â  Â  teeTimeWrapper.appendChild(el);
Â  });
}

Â  Â  function renderPlayers(){
Â  Â  Â  unpairedContainer.innerHTML = '';
Â  Â  Â  document.querySelectorAll('.player-drop-zone').forEach(z=>{
Â  Â  Â  Â  if(z.getAttribute('data-group')!=='unpaired') z.innerHTML='';
Â  Â  Â  });
Â  Â  Â  document.getElementById('unpairedCount').textContent =
Â  Â  Â  Â  allPlayers.filter(p=>p.group==='unpaired').length;

Â  Â  Â  allPlayers.forEach(p=>{
Â  Â  Â  Â  const card = document.createElement('div');
Â  Â  Â  Â  card.id = `player-${p.id}`;
Â  Â  Â  Â  card.draggable = true;
Â  Â  Â  Â  card.className = 'player-card p-3 bg-fpg-primary/10 border border-fpg-primary/50 rounded-lg text-sm font-semibold hover:bg-fpg-primary/20 transition duration-100 shadow-sm';
Â  Â  Â  Â  card.textContent = p.name;
Â  Â  Â  Â  card.setAttribute('data-id', p.id);

Â  Â  Â  Â  const target = p.group==='unpaired'
Â  Â  Â  Â  Â  ? unpairedContainer
Â  Â  Â  Â  Â  : document.querySelector(`.player-drop-zone[data-group="${p.group}"]`);

Â  Â  Â  Â  (target || unpairedContainer).appendChild(card);
Â  Â  if (!target) p.group = 'unpaired';
Â  });

Â  // âœ… Run once at the end â€” now dropdowns update properly
Â  updateScorekeeperDropdowns();
}

Â  Â  // ============== DND (native) ==============
Â  Â  function initDnd(){
Â  Â  Â  const dragstart = (e)=>{
Â  Â  Â  Â  if(!e.target.classList.contains('player-card')) return;
Â  Â  Â  Â  e.dataTransfer.setData('text/plain', e.target.getAttribute('data-id'));
Â  Â  Â  Â  e.target.classList.add('opacity-50','border-dashed','border-4','border-red-400');
Â  Â  Â  };
Â  Â  Â  const dragover = (e)=>{
Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  const zone = e.target.closest('.player-drop-zone'); 
Â  Â  Â  Â  // ğŸ› ï¸ Fix 1: Ensure only the currently dragged over zone is highlighted
Â  Â  Â  Â  document.querySelectorAll('.player-drop-zone.over').forEach(z=>z.classList.remove('over'));
Â  Â  Â  Â  if(zone) zone.classList.add('over');
Â  Â  Â  };
Â  Â  Â  const dragenter = (e)=>{
Â  Â  Â  Â  // ğŸ› ï¸ Removed original logic. Relying on dragover for 'over' class.
Â  Â  Â  };
Â  Â  Â  const dragleave = (e)=>{
Â  Â  Â  Â  // ğŸ› ï¸ Removed original logic. Relying on dragover for 'over' class.
Â  Â  Â  };
Â  Â  Â  const drop = (e)=>{
Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  const zone = e.target.closest('.player-drop-zone'); 
Â  Â  Â  Â  if(!zone) return;
Â  Â  Â  Â  zone.classList.remove('over');

Â  Â  Â  Â  const playerId = e.dataTransfer.getData('text/plain');
Â  Â  Â  Â  const card = document.getElementById(`player-${playerId}`);
Â  Â  Â  Â  const targetGroupId = zone.getAttribute('data-group');

Â  Â  Â  Â  const currentCount = Array.from(zone.children).filter(el=>el.classList.contains('player-card')).length;
Â  Â  Â  Â  if(targetGroupId!=='unpaired' && currentCount >= MAX_PLAYERS_PER_GROUP){
Â  Â  Â  Â  Â  statusElement.textContent = `Group ${parseInt(targetGroupId,10)+1} is full (max ${MAX_PLAYERS_PER_GROUP} players).`;
Â  Â  Â  Â  Â  statusElement.classList.add('text-red-600','font-bold');
Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  const idx = allPlayers.findIndex(p=>p.id===playerId);
Â  Â  Â  Â  if(idx>-1) allPlayers[idx].group = targetGroupId;

Â  Â  Â  Â  zone.appendChild(card);
Â  Â  Â  Â  statusElement.textContent = 'Pairing updated.';
Â  Â  Â  Â  statusElement.classList.remove('text-red-600','font-bold');
Â  Â  Â  Â  document.getElementById('unpairedCount').textContent =
Â  Â  Â  Â  Â  allPlayers.filter(p=>p.group==='unpaired').length;
Â  Â  Â  Â Â 
Â  Â  Â  Â  // ğŸ› ï¸ Scorekeepers must update on drop
Â  Â  Â  Â  updateScorekeeperDropdowns();

Â  Â  Â  };
Â  Â  Â  const dragend = (e)=>{
Â  Â  Â  Â  if(e.target && e.target.classList) e.target.classList.remove('opacity-50','border-dashed','border-4','border-red-400');
Â  Â  Â  Â  document.querySelectorAll('.player-drop-zone').forEach(z=>z.classList.remove('over'));
Â  Â  Â  };

Â  Â  Â  document.addEventListener('dragstart', dragstart);
Â  Â  Â  document.addEventListener('dragover', dragover);
Â  Â  Â  // document.addEventListener('dragenter', dragenter);
Â  Â  Â  // document.addEventListener('dragleave', dragleave);
Â  Â  Â  document.addEventListener('drop', drop);
Â  Â  Â  document.addEventListener('dragend', dragend);
Â  Â  }

Â  Â  // ============== DATA LOAD ==============
Â  Â  async function loadCheckinData(){
Â  Â  Â  document.getElementById('binIdDisplay').textContent = FINAL_PAIRINGS_BIN_ID;
Â  Â  Â  loadTeeTimes();

Â  Â  Â  // Fallback mock data (used only if live fetch fails)
Â  Â  Â  const mockNames = ['Joe','Sarah','Mike','Karen','David','Lisa','Tom','Amy','Sam','Ella','Ben','Chloe','Ryan','Zoe','Mark'];
Â  Â  Â  const mockPlayers = mockNames.map((name,i)=>({
Â  Â  Â  Â  id:`p${i}`, name, group:'unpaired', handicap: Math.floor(Math.random()*25)+5
Â  Â  Â  }));

Â  Â  Â  statusElement.textContent = 'Attempting to fetch live player check-in data from Google Sheet...';
Â  Â  Â  statusElement.className = 'text-sm text-gray-600 mt-2';

try {
Â  const res = await fetch(CHECK_IN_API_URL, { cache: 'no-store' });
Â  if (!res.ok) throw new Error(`HTTP ${res.status}`);

Â  const raw = await res.text();

Â  // Parse CSV (handles commas inside quotes)
Â  const lines = raw.trim().split('\n').filter(l => l.trim() !== '');
Â  const rows = lines.slice(1).map(line => {
Â  Â  const cols = [];
Â  Â  let cur = '', inQuotes = false;
Â  Â  for (const ch of line) {
Â  Â  Â  if (ch === '"') { inQuotes = !inQuotes; continue; }
Â  Â  Â  if (ch === ',' && !inQuotes) { cols.push(cur); cur = ''; }
Â  Â  Â  else { cur += ch; }
Â  Â  }
Â  Â  cols.push(cur);
Â  Â  return cols.map(v => v.trim());
Â  });

Â  if (rows.length === 0) throw new Error('No data rows found in the CSV.');

Â  // Keep only upcoming rounds based on Event text (col B = index 1)
Â  const today = new Date(); today.setHours(0,0,0,0);
Â  const rowsData = rows.filter(cols => {
Â  Â  const eventText = cols[1] || '';
Â  Â  const m = eventText.match(/(January|February|March|April|May|June|July|August|September|October|November|December)\s+(\d{1,2})/i);
Â  Â  if (!m) return false;
Â  Â  const monthName = m[1];
Â  Â  const dayNum = parseInt(m[2], 10);
Â  Â  const eventDate = new Date(`${monthName} ${dayNum}, ${today.getFullYear()}`);
Â  Â  eventDate.setHours(0,0,0,0);
Â  Â  return eventDate >= today;
Â  });

Â  // Map to players (col C = name; others optional)
Â  allPlayers = rowsData.map((cols, i) => ({
Â  Â  id: `p${i}`,
Â  Â  name: cols[2] || 'Unknown',Â  // Player Name (Column C)
Â  Â  handicap: 0,
Â  Â  event: cols[1] || '',Â  Â  Â  Â  // Event (Column B)
Â  Â  status: cols[3] || '',Â  Â  Â  Â // Player Status (Column D)
Â  Â  guest: cols[4] || '',Â  Â  Â  Â  // Guest Name(s) (Column E)
Â  Â  group: 'unpaired'
Â  }));

Â  statusElement.textContent = `âœ… Successfully loaded ${allPlayers.length} players from live Google Sheet data.`;
Â  statusElement.className = 'text-sm text-green-700 mt-2 font-medium';
} catch (err) {
Â  console.error('Error loading check-in data:', err);
Â  statusElement.textContent = `âŒ Failed to load live data (${err.message}). Using fallback mock data.`;
Â  statusElement.className = 'text-sm text-red-600 mt-2 font-medium';
Â  allPlayers = mockPlayers;
}
// ğŸ›‘ THIS SECTION WAS MOVED TO THE TOP-LEVEL SCOPE TO BE ACCESSIBLE TO THE DROPS
/*
function updateScorekeeperDropdowns() {
Â  currentTeeTimes.forEach((time, idx) => {
Â  Â  const groupZone = document.querySelector(`.player-drop-zone[data-group="${idx}"]`);
Â  Â  if (!groupZone) return;

Â  Â  // Collect player names currently in this group
Â  Â  const playerCards = Array.from(groupZone.querySelectorAll('.player-card'));
Â  Â  const players = playerCards.map(card => card.textContent.trim());

Â  Â  // Get the dropdowns for this group
Â  Â  const scorekeeper1 = document.getElementById(`scorekeeper1-${idx}`);
Â  Â  const scorekeeper2 = document.getElementById(`scorekeeper2-${idx}`);

Â  Â  // Reset and populate each dropdown
Â  Â  [scorekeeper1, scorekeeper2].forEach(select => {
Â  Â  Â  if (!select) return;
Â  Â  Â  select.innerHTML = '<option value="">Select Player</option>';
Â  Â  Â  players.forEach(name => {
Â  Â  Â  Â  const opt = document.createElement('option');
Â  Â  Â  Â  opt.value = name;
Â  Â  Â  Â  opt.textContent = name;
Â  Â  Â  Â  select.appendChild(opt);
Â  Â  Â  });
Â  Â  });
Â  });
}
*/

Â  Â  Â  renderPlayers();
Â  Â  Â  initDnd();
Â  Â  }

Â  Â  // ============== PUBLISH ==============
Â  Â  async function publishPairings(masterKey){
Â  Â  Â  // Allow your actual ID. Only block if empty/placeholder.
Â  Â  Â  if(!FINAL_PAIRINGS_BIN_ID || FINAL_PAIRINGS_BIN_ID === 'YOUR_BIN_ID_HERE'){
Â  Â  Â  Â  statusElement.textContent = 'Error: Please set your FINAL_PAIRINGS_BIN_ID.';
Â  Â  Â  Â  statusElement.className = 'text-center font-medium text-red-600';
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  if(currentTeeTimes.some(t=>!t || t.trim()==='')){
Â  Â  Â  Â  statusElement.textContent = 'Warning: Tee times are not fully set. Please enter a valid start time.';
Â  Â  Â  Â  statusElement.className = 'text-center font-medium text-orange-500';
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  const finalPairings = [];
Â  Â  Â  currentTeeTimes.forEach((time, idx)=>{
Â  Â  Â  Â  const players = allPlayers.filter(p=>p.group === String(idx));
Â  Â  Â  Â  if(players.length>0){
Â  Â  Â  Â  Â  finalPairings.push({
Â  tee_time: time,
Â  group_number: idx+1,
Â  players: players.map(p => ({ name: p.name, handicap: p.handicap, id: p.id })),
Â  scorekeeper1: document.getElementById(`scorekeeper1-${idx}`)?.selectedOptions[0]?.textContent || '',
Â  scorekeeper2: document.getElementById(`scorekeeper2-${idx}`)?.selectedOptions[0]?.textContent || ''
});
Â  Â  Â  Â  }
Â  Â  Â  });

Â  Â  Â  const PUBLISH_URL = `https://api.jsonbin.io/v3/b/${FINAL_PAIRINGS_BIN_ID}`;

Â  Â  Â  statusElement.textContent = 'Publishing... Please wait.';
Â  Â  Â  statusElement.className = 'text-center font-medium text-gray-600';
Â  Â  Â  publishButton.disabled = true;

Â  Â  Â  try{
Â  Â  Â  Â  const resp = await fetch(PUBLISH_URL, {
Â  Â  Â  Â  Â  method:'PUT',
Â  Â  Â  Â  Â  headers:{
Â  Â  Â  Â  Â  Â  'Content-Type':'application/json',
Â  Â  Â  Â  Â  Â  'X-Master-Key': masterKey
Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  body: JSON.stringify(finalPairings)
Â  Â  Â  Â  });
Â  Â  Â  Â  if(!resp.ok){
Â  Â  Â  Â  Â  try{
Â  Â  Â  Â  Â  Â  const det = await resp.json();
Â  Â  Â  Â  Â  Â  console.warn('Server response:', det);
Â  Â  Â  Â  Â  }catch{}
Â  Â  Â  Â  Â  if(resp.status===401){ clearMasterKey(); }
Â  Â  Â  Â  Â  throw new Error(`Server rejected the request (Status: ${resp.status}). Key may be invalid or expired. Re-authenticate.`);
Â  Â  Â  Â  }
Â  Â  Â  Â  statusElement.textContent = 'âœ… Successfully Published! Pairings are live.';
Â  Â  Â  Â  statusElement.className = 'text-center font-medium text-green-700';
Â  Â  Â  }catch(err){
Â  Â  Â  Â  console.error('Publish failed:', err);
Â  Â  Â  Â  statusElement.textContent = `âŒ Publish failed! Error: ${err.message}`;
Â  Â  Â  Â  statusElement.className = 'text-center font-medium text-red-600';
Â  Â  Â  }finally{
Â  Â  Â  Â  publishButton.disabled = false;
Â  Â  Â  }
Â  Â  }

Â  Â  // Expose for HTML handlers
Â  Â  window.publishPairings = publishPairings;
Â  Â  window.checkAndPublish = checkAndPublish;
Â  Â  window.authenticateAndPublish = authenticateAndPublish;
Â  Â  window.closeModal = closeModal;
Â  Â  window.clearMasterKey = clearMasterKey;
Â  Â  window.calculateTeeTimes = calculateTeeTimes;

Â  Â  document.addEventListener('DOMContentLoaded', loadCheckinData);
Â  </script>
</body>
</html>
