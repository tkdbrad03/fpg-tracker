<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>FPG Scorekeeper</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  :root{--fpg:#3c763d}
  .tab-active{color:#1f2937;background:#d4edda}
  .dot{display:inline-block;width:.5rem;height:.5rem;border-radius:9999px;background:#16a34a;margin-left .25rem}
  .scroll-snap-x{scroll-snap-type:x mandatory}
  .snap{scroll-snap-align:start}
</style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen">

<!-- ===== Header (course / group / role) ===== -->
<header class="sticky top-0 z-10 bg-white/90 backdrop-blur border-b">
  <div class="max-w-4xl mx-auto px-4 py-3">
    <h1 id="hdrCourse" class="text-2xl font-extrabold text-gray-900">Course</h1>
    <p class="text-sm text-gray-600">
      <span id="hdrGroup">Group</span> • <span id="hdrRole">Role</span>
    </p>
  </div>
</header>

<!-- ===== Hole banner ===== -->
<section class="bg-white border-b">
  <div class="max-w-4xl mx-auto px-4 py-3 flex items-center justify-between">
    <div class="flex gap-6">
      <div><div class="text-xs text-gray-500">Hole</div><div id="holeNum" class="font-semibold text-lg">1</div></div>
      <div><div class="text-xs text-gray-500">Par</div><div id="holePar" class="font-semibold text-lg">4</div></div>
      <div><div class="text-xs text-gray-500">Stroke</div><div id="holeHcp" class="font-semibold text-lg">11</div></div>
    </div>
    <div class="flex gap-2">
      <button id="prevHole" class="px-3 py-1 rounded border text-sm">Prev</button>
      <button id="nextHole" class="px-3 py-1 rounded border text-sm bg-green-600 text-white border-green-600">Next</button>
    </div>
  </div>
</section>

<!-- ===== Tabs ===== -->
<nav class="bg-white border-b">
  <div class="max-w-4xl mx-auto px-1 grid grid-cols-3">
    <button data-tab="play" class="tab-active px-3 py-2 text-center text-sm font-semibold">Play</button>
    <button data-tab="card" class="px-3 py-2 text-center text-sm font-semibold">Card</button>
    <button data-tab="live" class="px-3 py-2 text-center text-sm font-semibold">Live</button>
  </div>
</nav>

<!-- ===== Views ===== -->
<main class="max-w-4xl mx-auto p-4 space-y-6">

  <!-- PLAY -->
  <section id="view-play" class="space-y-4">
    <!-- players -->
    <div class="grid grid-cols-2 sm:grid-cols-4 gap-3" id="playerGrid"></div>

    <!-- score pad -->
    <div class="bg-white rounded-xl shadow p-4">
      <div class="text-sm text-gray-500 mb-1">Entering score for</div>
      <div id="activePlayerLabel" class="font-semibold text-lg mb-3">—</div>

      <div class="text-sm text-gray-600 mb-1">Score</div>
      <div id="scorePad" class="grid grid-cols-10 gap-2">
        <!-- buttons injected -->
      </div>

      <div id="netNote" class="mt-3 text-sm text-gray-600"></div>
    </div>
  </section>

  <!-- CARD -->
  <section id="view-card" class="hidden">
    <div class="bg-white rounded-xl shadow overflow-x-auto">
      <table class="min-w-full text-sm">
        <thead class="bg-green-100/70 text-gray-800 sticky top-0">
          <tr id="cardHeadRow"></tr>
        </thead>
        <tbody id="cardBody"></tbody>
      </table>
    </div>
  </section>

  <!-- LIVE -->
  <section id="view-live" class="hidden space-y-3">
    <div id="liveList" class="space-y-3"></div>
    <div class="bg-blue-50 border border-blue-200 text-blue-900 rounded-xl p-4 text-sm">
      <b>How it works:</b> Stableford points are computed automatically from the gross score and any stroke(s) the player receives on a hole. Verification between scorekeepers can be applied later (9/18-hole attest).
    </div>
  </section>

</main>

<script>
/* ========= helpers ========= */
const $ = (q) => document.querySelector(q);
const el = (t, cls='') => { const x=document.createElement(t); if(cls) x.className=cls; return x; };

function clamp(n,min,max){return Math.max(min,Math.min(max,n))}
function stablefordPoints(gross, par, netStrokes=0){
  if(!gross||!par) return 0;
  const net = gross - netStrokes;
  const diff = net - par;
  if(diff<=-3) return 5; // albatross
  if(diff===-2) return 4; // eagle
  if(diff===-1) return 3; // birdie
  if(diff===0)  return 2; // par
  if(diff===1)  return 1; // bogey
  return 0;               // double or higher
}

/* ========= state ========= */
let SELECTED_COURSE = null;      // object from localStorage
let SELECTED_GROUP_INDEX = null; // number (string saved)
let IS_SCOREKEEPER = false;

let courseName = '';
let group = null;                // selected group object
let holes = [];                  // [{par,hcp},...18]
let players = [];                // [{name, handicap?}, ...]
let currentHole = 0;             // 0..17
let activeIdx = 0;               // player index active

// scores[playerIdx][holeIdx] = {gross, points}
let scores = [];

/* ========= bootstrap from start screen ========= */
(function boot(){
  try{
    SELECTED_COURSE = JSON.parse(localStorage.getItem('selectedCourse'));
    SELECTED_GROUP_INDEX = localStorage.getItem('selectedGroup');
    IS_SCOREKEEPER = JSON.parse(localStorage.getItem('isScorekeeper'));
  }catch(e){}
  if(!SELECTED_COURSE || SELECTED_GROUP_INDEX===null){
    alert('Missing selections. Please choose course & group.');
    location.href = './';
    return;
  }
  courseName = SELECTED_COURSE.course_name || 'FPG Event';
  group = SELECTED_COURSE.groups[+SELECTED_GROUP_INDEX];
  players = (group.players || []).map(p => typeof p==='string' ? ({name:p, handicap:0}) : p);
  // holes: from JSONBin courses map if present on selectedCourse; else fallback to 18 par-4 with hcp index order
  if(SELECTED_COURSE.course_holes && SELECTED_COURSE.course_holes.length===18){
    holes = SELECTED_COURSE.course_holes.map(h => ({par:+h.par, hcp:+h.hcp||+h.stroke_index||1}));
  } else if(SELECTED_COURSE.courses && SELECTED_COURSE.courses[courseName]) {
    holes = SELECTED_COURSE.courses[courseName].map(h => ({par:+h.par, hcp:+h.hcp}));
  } else {
    holes = Array.from({length:18}, (_,i)=>({par:4, hcp:i+1}));
  }

  // init scores
  scores = players.map(()=> holes.map(()=>({gross:null, points:0})));

  // header
  $('#hdrCourse').textContent = courseName;
  $('#hdrGroup').textContent = `Group ${group.group_number || ( +SELECTED_GROUP_INDEX + 1)} – ${group.tee_time || ''}`;
  $('#hdrRole').textContent = IS_SCOREKEEPER ? 'Scorekeeper' : 'Player';

  // build UI
  buildPlayers();
  buildScorePad();
  buildCardSkeleton();
  updateHoleBanner();
  selectPlayer(0);
  renderCard();
  renderLive();
})();

/* ========= UI builders ========= */
function buildPlayers(){
  const wrap = $('#playerGrid'); wrap.innerHTML = '';
  players.forEach((p,idx)=>{
    const box = el('button','text-left bg-white rounded-xl border shadow-sm px-3 py-2 hover:border-green-600 focus:ring-2 focus:ring-green-600/20');
    box.dataset.idx = idx;
    box.addEventListener('click',()=>selectPlayer(idx));
    const title = el('div','font-semibold');
    title.textContent = p.name;
    const meta = el('div','text-xs text-gray-500 mt-0.5 flex items-center gap-1');
    const h = Math.max(0, Math.round(+p.handicap || 0)); // tiny handicap text
    meta.textContent = h ? `HCP ${h}` : 'HCP —';
    // stroke dot placeholder (will toggle per-hole)
    const dot = el('span'); dot.className='dot'; dot.style.display='none'; dot.title='Stroke on this hole';
    dot.id = `dot-${idx}`;
    meta.appendChild(dot);

    box.appendChild(title);
    box.appendChild(meta);
    wrap.appendChild(box);
  });
}

function buildScorePad(){
  const pad = $('#scorePad'); pad.innerHTML='';
  for(let n=1;n<=10;n++){
    const b=el('button','border rounded py-2 text-sm hover:bg-gray-100');
    b.textContent = n;
    b.addEventListener('click', ()=>setScore(n));
    pad.appendChild(b);
  }
}

function buildCardSkeleton(){
  const head = $('#cardHeadRow'); head.innerHTML='';
  ;['Hole','Par', ...players.map(p=>p.name.split(' ')[0])].forEach(txt=>{
    const th=el('th','px-3 py-2 text-left font-semibold'); th.textContent=txt; head.appendChild(th);
  });
}

/* ========= per-hole UI updates ========= */
function updateHoleBanner(){
  const h = holes[currentHole] || {par:4,hcp:1};
  $('#holeNum').textContent = currentHole+1;
  $('#holePar').textContent = h.par;
  $('#holeHcp').textContent = h.hcp;

  // stroke dot toggles for each player
  players.forEach((p,idx)=>{
    const given = strokeGivenFor(p, h.hcp);
    const dot = $(`#dot-${idx}`);
    if(dot) dot.style.display = given ? 'inline-block' : 'none';
  });

  renderCard(); // keep table header row sticky but body values reflect current known
  renderLive();
}

function selectPlayer(idx){
  activeIdx = idx;
  const p = players[idx];
  $('#activePlayerLabel').textContent = p.name;
  // highlight
  [...document.querySelectorAll('#playerGrid > button')].forEach((b,i)=>{
    b.classList.toggle('ring-2', i===idx);
    b.classList.toggle('ring-green-600', i===idx);
  });

  const h = holes[currentHole];
  const netStrokes = strokeGivenFor(p, h.hcp);
  $('#netNote').textContent = netStrokes ? `This hole: receives ${netStrokes} stroke${netStrokes>1?'s':''}.` : 'This hole: no stroke.';
}

/* ========= strokes logic ========= */
// Max 18 strokes; allocate 1 on holes with stroke index <= strokesGiven (and one extra round if >18, but we cap).
function totalStrokesGivenFor(player){
  // if you later store an explicit "strokes_given" on player, prefer that and cap to 18.
  const hcpNum = Math.round(+player.handicap || 0);
  return clamp(hcpNum, 0, 18);
}
function strokeGivenFor(player, holeHcp){
  const s = totalStrokesGivenFor(player);
  return s>0 && holeHcp <= s ? 1 : 0;
}

/* ========= scoring ========= */
function setScore(gross){
  scores[activeIdx][currentHole].gross = gross;
  const par = holes[currentHole].par;
  const netStrokes = strokeGivenFor(players[activeIdx], holes[currentHole].hcp);
  scores[activeIdx][currentHole].points = stablefordPoints(gross, par, netStrokes);
  renderCard();
  renderLive();
}

/* ========= renderers ========= */
function renderCard(){
  const body = $('#cardBody'); body.innerHTML='';
  holes.forEach((h,hi)=>{
    const tr = el('tr', hi%2? 'bg-white' : 'bg-gray-50');
    const c1 = el('td','px-3 py-2 font-semibold'); c1.textContent = hi+1; tr.appendChild(c1);
    const c2 = el('td','px-3 py-2'); c2.textContent = h.par; tr.appendChild(c2);
    players.forEach((p,pi)=>{
      const cell = el('td','px-3 py-2');
      const sc = scores[pi][hi];
      cell.textContent = sc.gross ?? '—';
      // little hourglass for unscored current hole in the example; here we show a tiny dot if stroke applies (reference)
      if(sc.gross==null && strokeGivenFor(p,h.hcp)){
        const sdot = el('span'); sdot.className='dot ml-1 align-middle'; cell.appendChild(sdot);
      }
      tr.appendChild(cell);
    });
    body.appendChild(tr);
  });
}

function renderLive(){
  // aggregate Stableford + gross strokes entered so far
  const rows = players.map((p,pi)=>{
    let pts=0, strokes=0, holesPlayed=0;
    scores[pi].forEach(s=>{
      if(s.gross!=null){ pts+=s.points; strokes+=s.gross; holesPlayed++; }
    });
    return {name:p.name, pts, strokes, holesPlayed};
  }).sort((a,b)=> b.pts - a.pts || a.strokes - b.strokes);

  const wrap = $('#liveList'); wrap.innerHTML='';
  rows.forEach((r,idx)=>{
    const card = el('div','rounded-xl border-l-4 bg-white shadow px-4 py-3 flex items-center');
    card.style.borderLeftColor = ['#FACC15','#9CA3AF','#B45309'][idx] || '#3c763d';
    const left = el('div','text-2xl font-extrabold w-10 text-center'); left.textContent = idx+1;
    const mid = el('div','flex-1');
    const name = el('div','font-semibold'); name.textContent = r.name;
    const sub  = el('div','text-xs text-gray-500'); sub.textContent = `Through ${r.holesPlayed} hole${r.holesPlayed===1?'':'s'}`;
    mid.append(name, sub);
    const pts = el('div','text-right');
    pts.innerHTML = `<div class="text-2xl font-extrabold text-green-700">${r.pts}</div><div class="text-xs text-gray-500">${r.strokes||0} strokes</div>`;
    card.append(left, mid, pts);
    wrap.appendChild(card);
  });
}

/* ========= nav ========= */
const tabs = [...document.querySelectorAll('nav [data-tab]')];
function show(tab){
  tabs.forEach(b=>b.classList.toggle('tab-active', b.dataset.tab===tab));
  $('#view-play').classList.toggle('hidden', tab!=='play');
  $('#view-card').classList.toggle('hidden', tab!=='card');
  $('#view-live').classList.toggle('hidden', tab!=='live');
}
tabs.forEach(b=>b.addEventListener('click',()=>show(b.dataset.tab)));

$('#prevHole').addEventListener('click',()=>{
  currentHole = Math.max(0, currentHole-1);
  updateHoleBanner();
});
$('#nextHole').addEventListener('click',()=>{
  currentHole = Math.min(17, currentHole+1);
  updateHoleBanner();
});
</script>
</body>
</html>
